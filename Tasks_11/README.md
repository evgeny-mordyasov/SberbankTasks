Задание:

Есть банк. В нем N счетов и M клиентов.
Клиент может переводить деньги с одного счёта на другой.

Необходимо создать демона наблюдателя, который будет следить, что всё ок - что денежная масса в системе постоянна -- нет утечек). Денежный пул создаётся при запуске программы, он фиксирован и указывается через проперти файл

В программе должно работать одновременно >= 30 потоков. Количество M и N также задаются через проперти.

Подсказки:

Не используйте для синхронизации один общий глобальный объект (в таком слкчае когда демон будет сверять счета то банк остановится)


Кроме того, проверьте что обработаны следующие ситуации:

Проблема синхронизации:
Клиент снял со счёта 1 сумму X, с целью положить его на счёт 2.
Демон проверил сумму на счёте 1.
Демон проверил сумму на счёте 2.
Клиент положил сумму X на счёт 2.

Таким образом демон недосчитался X. Эту ситуацию нужно обработать.

Если клиент хочет сделать перевод межлу счетами, то он сначала должен убедиться что требуемая сумма действительно есть на счёте. Если нет - то клиент может либо попытаться перевести сумму поменьше попробовать в следующий раз.

Демон должен чекать суммы, актуально лежащие на счетах. можно сделать и дополнительные внутренние проверки

Тесты:
1. Положительный сценарий:
Запускаем N клиентов M счетов(не менее 70). Все ок.
2. Негативный сценарий:
Даем какому-нибудь клиенту слишком большую сумму (больше общего amount). запускаем N клиентов  М счетов (не менее 70). Ожидаем, что будет исключение от демона.
3. Положительный сценарий. 
Запускаем N клиентов (не менее 70), которые работают только с двумя счетами. Все ок.



----------------------------------------------------------------------------------------------------------------------------

Решение:

В данной лабораторной работе представлен процесс перевода денежных средств с одного счета на другой путем задействования многопоточного выполнения программы.

Иерархия приложенного кода:

1) Основной код:
- пакет bank;
- пакет config.

2) Тестовый код:
- класс BankTest.

3) Ресурсы.
- пакет configs.

Описание достигнутой синхронизации:
Всего в программе три вида потоков:
1) Главный поток (запуск тестовых методов);
2) Поток-наблюдатель (так называемый поток-демон);
3) Потоки-клиенты (осуществляют денежный трансфер).

Если для главного потока неважна синхронизация (отвечает только за тестирование), то для потока-наблюдателя и потока-клиентов дела обстоят иначе. Общий ресурс, к которому обращаются эти потоки - это список счетов, выступающих в роли хранилища денежных средств. Поток-наблюдатель использует общий ресурс (список счетов) для подсчета суммы всех счетов для выявления сбоя при переводе денежных средств. Потоки-клиенты используют этот ресурс для получения случайным образом двух счетов, между которыми будет происходить денежный трансфер. Поэтому во избежание ошибок необходима синхронизациями между этими потоками. Она достигнута вот таким образом: поток-клиент, получив случайным образом два счета, перед тем, как совершить перевод денежных средств, обязан заблокировать доступ к этим счетам для других потоков (блокировка осуществляется с помощью класса ReentrantLock). Получив блокировки над этими счетами, поток-клиент может безопасно совершить денежный трансфер, не опасаясь, что эти счета будут под контролем другого потока. Однако существует вероятность наступления следующего события. Пусть у нас есть два потока: thread1, thread2, а также два счета: a1, a2. Предположим, потоку thread1 выпали счета a1, a2, а потоку thread2 - a2, a1. Поток thread1 успел захватить блокировку счета a1, поток thread2 - a2. Получается, для дальнейшей работы потоку thread1 необходим счет a2, но он заблокирован потоком thread2. А поток thread2 нуждается в счете a1, который заблокирован thread1. То есть, пришли к deadlock. Во избежание данной ситуации найденные индексы счетов мы будем сортировать по возрастанию. Тогда в вышеописанной ситуации два потока пытались б взять блокировку счета a1. И кто успеет, тот и сможет заблокировать второй счет a2.
Перейдем теперь к потоку-наблюдателю. Как говорилось выше, он подсчитывает суммы всех счетов в банке. Но чтобы подсчитать суммы этих счетов - необходимо их получить. А получение счетов осуществляется его блокировкой. То есть, когда приходит время для подсчета суммы - он пробегается по всем счетам, блокируя к ним доступ. Причем, пока счет не будет разблокирован потоком-клиентом, поток-наблюдатель не сможет насильно получить доступ к счету. Получив все блокировки, поток-наблюдатель клонирует все счета, а после снимает блокировки с них. Клонирование необходимо для того, чтобы при подсчете суммы потоки-клиенты не ожидали, когда блокировки с счетов будут сняты. А блокировки всех счетов необходимо, чтобы при клонировании поток-наблюдатель смог получить корректное состояние счетов. Иначе говоря, избежать такую ситуацию: поток-наблюдатель совершил клонирование счета a1. Поток-клиент снял со счета a1 некоторую сумму и пополнил ее на счете a2. Поток-наблюдатель совершил клонирование счета a2. Получается, что в итоговой сумме прибавилось N-я сумма, отличающаяся от действительной.

Краткое описание классов:
Пакет bank содержит в себе пять классов.

1) Класс Account представляет собой счет, на котором будет храниться некоторая сумма. Содержит в себе блокировку во избежание общего доступа.

2) Класс Bank представляет собой хранилище всех счетов, между которыми совершается процесс перевода денежных средств.

3) Класс Client представляет собой поток-клиент, который будет совершать денежный трансфер между двумя счетами, полученными случайным образом.

4) Класс DaemonThread представляет собой поток-наблюдатель, который в течение выполнения программы будет подсчитывать сумму всех счетов, блокируя к ним доступ.

5) Класс RandomParameters представляет собой дополнительной реализацией получения случайных величин (в данном случае два счета и сумму перевода).

Пакет config содержит в себе два класса.

1) Класс ConfigProperties представляет собой мостом между файлом .properties и Java-кодом. Необходим для того, чтобы получить доступ к файлу и иметь возможность к извлечению информации из него.

2) Класс CurrentConfig представляет собой текущей (действующей) конфигурацией настроек .properties файла. Создан для того, чтобы в некоторых классах явно не протаскивать имя .properties файла, нагружая тем самым ненужной ответственностью.

Класс BankTest.

В данном классе смоделированы три конкретных ситуаций, позволяющих проверить работоспособность написанного кода. Тест считается запущенным без проблем, если корректно выбран .properties файл с указанными конфигурационными настройками.

Ресурсы.

Представляют собой в виде трех .properties файлов, содержащих конфигурационные настройки под определенную ситуацию. В каждом файле представлена документация о существующих свойств.
